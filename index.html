<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BRITS ABROAD 2025 â€” Mediterranean Luxury</title>
<meta name="theme-color" content="#F5ECE0"/>
<style>
  /* Mediterranean warm theme (beige / terracotta) */
  :root{
    --bg:#fbf7f2;
    --panel:#fff;
    --muted:#bfa089;
    --text:#2b2b2b;
    --accent:#c65a3a;   /* terracotta */
    --accent-2:#e8cfa6; /* sand */
    --success:#28a745;
    --glass: rgba(255,255,255,0.85);
    --radius:14px;
    --font: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#f3ece4);color:var(--text);font-family:var(--font);-webkit-font-smoothing:antialiased}
  .wrap{max-width:980px;margin:12px auto;padding:12px}
  header.card{background:linear-gradient(90deg,var(--panel),#fff);border-radius:var(--radius);padding:20px;margin-bottom:12px;box-shadow:0 8px 30px rgba(0,0,0,0.06);text-align:center}
  header h1{margin:0;font-size:1.9rem;color:var(--accent)}
  header p{margin:6px 0 0;color:var(--muted)}
  .phases{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0;overflow:auto;padding-bottom:6px}
  .phase{min-width:86px;height:86px;border-radius:12px;background:linear-gradient(180deg,#fff,#fff);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(0,0,0,0.03);padding:8px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.04)}
  .phase .ico{font-size:20px;margin-bottom:6px}
  .phase.active{background:linear-gradient(180deg,var(--accent),#b7462a);color:#fff;transform:scale(1.03)}
  .phase.completed{background:var(--success);color:#fff}
  .card{background:var(--panel);border-radius:var(--radius);padding:18px;margin:8px 0;box-shadow:0 10px 30px rgba(0,0,0,0.06)}
  label{display:block;font-size:0.95rem;color:var(--text);margin-bottom:6px}
  select,input,textarea,button{font-family:var(--font);font-size:1rem}
  select, input[type=number], input[type=month], textarea {width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff}
  input[type=range]{width:100%;margin:8px 0;accent-color:var(--accent)}
  textarea{min-height:88px;border-radius:10px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted);font-size:0.95rem}
  button{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}
  .summaryBox{background:linear-gradient(90deg,#fff,#fff);padding:14px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);color:var(--text);white-space:pre-wrap}
  .small{font-size:0.92rem;color:var(--muted)}
  .progress{height:12px;background:#f6efe6;border-radius:999px;overflow:hidden;margin-bottom:10px}
  .progressFill{height:100%;width:0%;background:var(--accent);transition:width .35s}
  .countdown{display:inline-block;padding:10px 14px;background:var(--accent-2);border-radius:10px;color:var(--text);font-weight:700}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04);text-align:left}
  th{background:var(--accent);color:#fff;font-weight:600}
  @media(max-width:720px){header h1{font-size:1.5rem}.phase{min-width:70px;height:70px}}
</style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <h1>BRITS ABROAD 2025</h1>
      <p class="small">Mediterranean-style relocation planner â€” warm, elegant, travel-first</p>
    </header>

    <div class="card">
      <div class="progress"><div class="progressFill" id="progressFill"></div></div>
      <div class="phases" id="phaseStrip" aria-label="Phases navigation"></div>
    </div>

    <main id="content">
      <!-- Phase cards (all present, only one visible at a time) -->

      <!-- Phase 1 -->
      <section id="phase1" class="card">
        <h2>Phase 1 â€” Dream Destination</h2>
        <label for="country">Choose country</label>
        <select id="country"></select>

        <label for="cityPref" style="margin-top:10px">City / area preference (optional)</label>
        <input id="cityPref" type="text" placeholder="e.g. Algarve, Lisbon, Crete">

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(1)">Mark Phase 1 Complete</button>
          <button class="ghost" onclick="showPhase(2)">Next: Finance</button>
        </div>
      </section>

      <!-- Phase 2 -->
      <section id="phase2" class="card" style="display:none">
        <h2>Phase 2 â€” Financial Freedom</h2>
        <div class="row" style="align-items:flex-end">
          <div style="flex:1;min-width:180px">
            <label>Annual pension (Â£)</label>
            <input id="pension" type="range" min="0" max="60000" value="10000" oninput="calcFinance()">
            <div class="small">Â£<span id="pensionVal">10,000</span></div>
          </div>
          <div style="flex:1;min-width:180px">
            <label>UK property value (Â£)</label>
            <input id="propertyValInput" type="range" min="0" max="2000000" step="10000" value="300000" oninput="calcFinance()">
            <div class="small">Â£<span id="propertyValText">300,000</span></div>
          </div>
        </div>

        <div style="margin-top:12px" class="summaryBox" id="financeSummary">Savings estimate will appear here</div>

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(2)">Mark Phase 2 Complete</button>
          <button class="ghost" onclick="showPhase(3)">Next: Visa</button>
        </div>
      </section>

      <!-- Phase 3 -->
      <section id="phase3" class="card" style="display:none">
        <h2>Phase 3 â€” Visa Victory</h2>
        <div class="row">
          <label style="flex:1">
            Income bracket
            <select id="q1" onchange="updateVisa()">
              <option value="">Select</option>
              <option value="0">Under â‚¬870</option>
              <option value="1">â‚¬870â€“â‚¬3,279</option>
              <option value="2">â‚¬3,280+</option>
            </select>
          </label>
          <label style="flex:1">
            Remote work?
            <select id="q2" onchange="updateVisa()">
              <option value="">Select</option>
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
          </label>
          <label style="flex:1">
            Family joining?
            <select id="q4" onchange="updateVisa()">
              <option value="">Select</option>
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
          </label>
        </div>

        <div style="margin-top:12px" class="summaryBox" id="visaSummary">Visa guidance will appear here</div>

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(3)">Mark Phase 3 Complete</button>
          <button class="ghost" onclick="showPhase(4)">Next: Documents</button>
        </div>
      </section>

      <!-- Phase 4 -->
      <section id="phase4" class="card" style="display:none">
        <h2>Phase 4 â€” Document Checklist</h2>
        <p class="small">Upload your files (local filenames are shown; files are not uploaded to any server).</p>
        <input id="docs" type="file" multiple />
        <div style="margin-top:10px" class="summaryBox" id="docsSummary">No files chosen</div>

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(4)">Mark Phase 4 Complete</button>
          <button class="ghost" onclick="showPhase(5)">Next: Budget</button>
        </div>
      </section>

      <!-- Phase 5 -->
      <section id="phase5" class="card" style="display:none">
        <h2>Phase 5 â€” Budget Blueprint</h2>
        <label>Monthly income (Â£)</label>
        <input id="budgetIncome" type="number" min="0" value="2000" oninput="updateBudget()">

        <label style="margin-top:8px">Monthly expenses (Â£)</label>
        <input id="budgetExpenses" type="number" min="0" value="1200" oninput="updateBudget()">

        <div style="margin-top:12px" class="summaryBox" id="budgetSummary">Balance will appear here</div>

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(5)">Mark Phase 5 Complete</button>
          <button class="ghost" onclick="showPhase(6)">Next: Move</button>
        </div>
      </section>

      <!-- Phase 6 -->
      <section id="phase6" class="card" style="display:none">
        <h2>Phase 6 â€” Move Mastery</h2>
        <div class="row">
          <label><input id="pack1" type="checkbox" onchange="updateMove()"> Book movers</label>
          <label><input id="pack2" type="checkbox" onchange="updateMove()"> Arrange storage</label>
          <label><input id="pack3" type="checkbox" onchange="updateMove()"> Notify bank & utilities</label>
        </div>

        <div style="margin-top:12px" class="summaryBox" id="moveSummary">Move tasks status</div>

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(6)">Mark Phase 6 Complete</button>
          <button class="ghost" onclick="showPhase(7)">Next: Settlement</button>
        </div>
      </section>

      <!-- Phase 7 -->
      <section id="phase7" class="card" style="display:none">
        <h2>Phase 7 â€” Settlement Success</h2>
        <label>Rent / mortgage target (Â£/month)</label>
        <input id="propertyRent" type="number" min="0" value="1200" oninput="updateSettlement()">

        <label style="margin-top:8px">Preferred area</label>
        <input id="settleArea" type="text" placeholder="e.g. Old Town" oninput="updateSettlement()">

        <div style="margin-top:12px" class="summaryBox" id="settleSummary">Settlement details</div>

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(7)">Mark Phase 7 Complete</button>
          <button class="ghost" onclick="showPhase(8)">Next: Community</button>
        </div>
      </section>

      <!-- Phase 8 -->
      <section id="phase8" class="card" style="display:none">
        <h2>Phase 8 â€” Community Connections</h2>
        <div class="row">
          <label><input id="conn1" type="checkbox" onchange="updateConnections()"> Join expat group</label>
          <label><input id="conn2" type="checkbox" onchange="updateConnections()"> Learn local language</label>
          <label><input id="conn3" type="checkbox" onchange="updateConnections()"> Attend meetups</label>
        </div>

        <div style="margin-top:12px" class="summaryBox" id="connSummary">Connections status</div>

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(8)">Mark Phase 8 Complete</button>
          <button class="ghost" onclick="showPhase(9)">Next: Tax</button>
        </div>
      </section>

      <!-- Phase 9 -->
      <section id="phase9" class="card" style="display:none">
        <h2>Phase 9 â€” Tax Triumph</h2>
        <label>Tax residency plan</label>
        <select id="taxStatus" onchange="updateTax()">
          <option value="UK">Remain UK</option>
          <option value="Host">Host country</option>
          <option value="Split">Split / Dual</option>
        </select>

        <div style="margin-top:12px" class="summaryBox" id="taxSummary">Tax guidance</div>

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(9)">Mark Phase 9 Complete</button>
          <button class="ghost" onclick="showPhase(10)">Next: Celebrate</button>
        </div>
      </section>

      <!-- Phase 10 -->
      <section id="phase10" class="card" style="display:none">
        <h2>Phase 10 â€” Celebration Station</h2>
        <label>Celebration plan (notes)</label>
        <input id="celebrationPlan" type="text" placeholder="Welcome party / dinner" oninput="updateCelebration()">

        <div style="margin-top:12px" class="summaryBox" id="celebrationSummary">Party plan</div>

        <div style="margin-top:12px" class="row">
          <button onclick="completePhase(10)">Mark Phase 10 Complete</button>
          <button class="ghost" onclick="showPhase(11)">Next: AI Summary</button>
        </div>
      </section>

      <!-- Phase 11 -->
      <section id="phase11" class="card" style="display:none">
        <h2>Phase 11 â€” Retirement Summary</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
          <button onclick="getAISummary()">Generate AI Summary</button>
          <button class="ghost" onclick="exportPlan()">Export JSON</button>
          <button class="ghost" onclick="copySummary()">Copy Summary</button>
          <button class="ghost" onclick="resetAll()">Reset</button>
        </div>

        <div style="margin-top:8px" class="summaryBox" id="aiSummary">Click Generate AI Summary to create your consultant-style plan</div>

        <div id="breakdown" style="margin-top:12px; display:none" class="card">
          <h3 style="margin:0 0 8px">Numeric breakdown</h3>
          <table id="breakTable"><thead><tr><th>Item</th><th>Estimate</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

    </main>

    <div style="text-align:center;margin-top:12px">
      <div class="countdown" id="countdown">Calculating...</div>
    </div>
  </div>

<script>
/* ------------- Data ------------- */
const PHASES = [
  {id:1,title:'Dream Destination',icon:'ðŸŒ'},
  {id:2,title:'Financial Freedom',icon:'ðŸ’°'},
  {id:3,title:'Visa Victory',icon:'ðŸ“‹'},
  {id:4,title:'Document Checklist',icon:'ðŸ“'},
  {id:5,title:'Budget Blueprint',icon:'ðŸ“Š'},
  {id:6,title:'Move Mastery',icon:'ðŸšš'},
  {id:7,title:'Settlement Success',icon:'ðŸ '},
  {id:8,title:'Community Connections',icon:'ðŸ‘¥'},
  {id:9,title:'Tax Triumph',icon:'ðŸ’¼'},
  {id:10,title:'Celebration Station',icon:'ðŸŽ‰'},
  {id:11,title:'Retirement Summary',icon:'ðŸ‘´'}
];
const COUNTRIES = {Portugal:1,Spain:1.05,UAE:1.6,Thailand:0.6,Cyprus:1,Greece:1.1,Italy:1.2,France:1.25,Poland:0.6,Malta:1.05};

/* ------------- State ------------- */
let currentPhase = 1;
let completed = [];

/* ------------- Elements ------------- */
const phaseStrip = document.getElementById('phaseStrip');
const progressFill = document.getElementById('progressFill');
const countrySelect = document.getElementById('country');

/* ------------- Build phase strip ------------- */
function buildPhaseStrip(){
  phaseStrip.innerHTML = '';
  PHASES.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'phase';
    el.dataset.phase = p.id;
    el.innerHTML = `<div class="ico">${p.icon}</div><div style="font-size:.85rem">${p.title}</div>`;
    el.addEventListener('click', ()=> showPhase(p.id));
    if(completed.includes(p.id)) el.classList.add('completed');
    if(p.id === currentPhase) el.classList.add('active');
    phaseStrip.appendChild(el);
  });
  updateProgress();
}

/* ------------- Progress ------------- */
function updateProgress(){
  const pct = Math.round((currentPhase / PHASES.length) * 100);
  progressFill.style.width = pct + '%';
  document.querySelectorAll('.phase').forEach(n => n.classList.toggle('active', Number(n.dataset.phase) === currentPhase));
}

/* ------------- Show Phase ------------- */
function showPhase(n){
  PHASES.forEach(p=>{
    const sec = document.getElementById('phase' + p.id);
    if(!sec) return;
    sec.style.display = (p.id === n) ? 'block' : 'none';
  });
  currentPhase = n;
  updateProgress();
  // mobile: scroll to top
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ------------- Complete Phase ------------- */
function completePhase(n){
  if(!completed.includes(n)) completed.push(n);
  localStorage.setItem('ba_completed', JSON.stringify(completed));
  const next = n+1;
  if(next <= PHASES.length) showPhase(next);
  buildPhaseStrip();
  saveDraft();
}

/* ------------- Populate countries & restore ------------- */
function populateCountries(){
  countrySelect.innerHTML = '';
  Object.keys(COUNTRIES).forEach(c=>{
    const o = document.createElement('option'); o.value = c; o.textContent = c;
    countrySelect.appendChild(o);
  });
  countrySelect.value = localStorage.getItem('ba_country') || 'Portugal';
  countrySelect.addEventListener('change', ()=>{
    localStorage.setItem('ba_country', countrySelect.value);
    calcFinance();
  });
}

/* ------------- Phase 2 finance ------------- */
function calcFinance(){
  const pension = Number(document.getElementById('pension').value || 0);
  const property = Number(document.getElementById('propertyValInput').value || 0);
  document.getElementById('pensionVal').textContent = pension.toLocaleString();
  document.getElementById('propertyValText').textContent = property.toLocaleString();
  const mult = COUNTRIES[countrySelect.value] || 1;
  const savings = Math.round((pension * 0.35 + property * 0.0025) * mult);
  document.getElementById('financeSummary').textContent = `Estimated annual savings: Â£${savings.toLocaleString()} (using a country cost multiplier of ${mult})`;
  saveDraft();
}

/* ------------- Phase 3 visa ------------- */
function updateVisa(){
  const inc = document.getElementById('q1').value;
  const remote = document.getElementById('q2').value;
  const fam = document.getElementById('q4').value;
  let advice = '';
  if(!inc) advice = 'Select income bracket for visa options.';
  else {
    if(inc === '2' && remote === '1') advice = 'Digital Nomad likely; explore remote-worker visas.';
    else if(inc === '2') advice = 'Investor / high-income routes; consider Golden visas.';
    else if(inc === '1') advice = 'Passive-income visas (D7, Non-lucrative) likely.';
    else advice = 'Lower-income routes require local permits or lower-cost countries.';
    if(fam === '1') advice += ' Family inclusion possible â€” check specific rules.';
  }
  document.getElementById('visaSummary').textContent = advice;
  saveDraft();
}

/* ------------- Phase 4 docs ------------- */
document.getElementById('docs').addEventListener('change', (e)=>{
  const names = Array.from(e.target.files || []).map(f => f.name);
  document.getElementById('docsSummary').textContent = names.length ? names.join(' | ') : 'No files chosen';
  saveDraft();
});

/* ------------- Phase 5 budget ------------- */
function updateBudget(){
  const income = Number(document.getElementById('budgetIncome').value || 0);
  const expenses = Number(document.getElementById('budgetExpenses').value || 0);
  const balance = income - expenses;
  document.getElementById('budgetSummary').textContent = `Monthly surplus: Â£${balance.toLocaleString()}`;
  saveDraft();
}

/* ------------- Phase 6 move ------------- */
function updateMove(){
  const done = [];
  ['pack1','pack2','pack3'].forEach(id=>{
    const el = document.getElementById(id);
    if(el && el.checked) done.push(el.parentNode.textContent.trim());
  });
  document.getElementById('moveSummary').textContent = done.length ? `Completed: ${done.join(', ')}` : 'No tasks ticked';
  saveDraft();
}

/* ------------- Phase 7 settlement ------------- */
function updateSettlement(){
  const rent = Number(document.getElementById('propertyRent').value || 0);
  const area = document.getElementById('settleArea').value || '';
  document.getElementById('settleSummary').textContent = `Target rent/mortgage: Â£${rent.toLocaleString()} â€” Area: ${area}`;
  saveDraft();
}

/* ------------- Phase 8 connections ------------- */
function updateConnections(){
  const picks = [];
  ['conn1','conn2','conn3'].forEach(id=>{
    const el = document.getElementById(id);
    if(el && el.checked) picks.push(el.parentNode.textContent.trim());
  });
  document.getElementById('connSummary').textContent = picks.length ? `Planned: ${picks.join(', ')}` : 'No connections planned';
  saveDraft();
}

/* ------------- Phase 9 tax ------------- */
function updateTax(){
  const val = document.getElementById('taxStatus').value;
  const t = val === 'UK' ? 'Remain UK resident â€” check split-year rules' : val === 'Host' ? 'Host-country residency' : 'Consider dual/split residency';
  document.getElementById('taxSummary').textContent = t;
  saveDraft();
}

/* ------------- Phase 10 celebration ------------- */
function updateCelebration(){
  const plan = document.getElementById('celebrationPlan').value || '';
  document.getElementById('celebrationSummary').textContent = plan ? `Saved: ${plan}` : 'No plan';
  saveDraft();
}

/* ------------- AI Summary (placeholder) ------------- */
function getAISummary(){
  const data = collectData();
  const mult = COUNTRIES[data.country] || 1;
  const monthlyTarget = Number(data.budgetIncome || 2000);
  const estMonthly = Math.round(monthlyTarget * mult);
  const estAnnual = estMonthly * 12;
  const pension = Number(data.pension || 0);
  const prop = Number(data.propertyVal || 0);
  let readiness = 40;
  if(data.docs && data.docs.length) readiness += 15;
  if((Number(data.budgetIncome || 0) - Number(data.budgetExpenses || 0)) > 300) readiness += 10;
  if(pension > 8000) readiness += 10;
  if(data.pack1 && data.pack2) readiness += 10;
  if(data.conn1) readiness += 5;
  readiness = Math.min(100, readiness);

  // Long professional + conversational hybrid
  const parts = [];
  parts.push(`Hello â€” here's your personalised Mediterranean relocation plan (simulated AI)\n`);
  parts.push(`Destination: ${data.country || 'Not chosen'}${data.cityPref ? ' â€” ' + data.cityPref : ''}.`);
  parts.push(`Estimated monthly living costs (rough): Â£${estMonthly.toLocaleString()} (â‰ˆ Â£${estAnnual.toLocaleString()} per year).`);
  parts.push(`Housing target: Â£${(data.propertyRent || 'N/A')} / month. Property held in UK: Â£${prop.toLocaleString()}. Pension: Â£${pension.toLocaleString()}.`);
  parts.push(`\nVisa summary:\n${document.getElementById('visaSummary').textContent}\n`);
  parts.push(`Documents: ${data.docs && data.docs.length ? 'Files selected â€” good progress.' : 'No documents uploaded â€” gather passport, bank statements, income proof, police check.'}`);
  parts.push(`\nPractical next steps (consultant):`);
  parts.push(`1) Finalise documents & certified copies. 2) Arrange short viewing trip. 3) Speak to immigration advisor. 4) Reserve flexible shipping.\n`);
  parts.push(`Readiness score: ${readiness}/100 â€” ${ readiness > 75 ? 'Very ready' : readiness > 50 ? 'Some prep left' : 'More prep recommended' }.\n`);
  parts.push(`If you'd like, I can generate application letter templates, a document checklist PDF, or a personalised timeline next.`);

  document.getElementById('aiSummary').textContent = parts.join('\n\n');

  // numeric breakdown
  const tbody = document.querySelector('#breakTable tbody');
  tbody.innerHTML = '';
  const rows = [
    ['Estimated monthly cost', `Â£${estMonthly.toLocaleString()}`],
    ['Estimated annual cost', `Â£${estAnnual.toLocaleString()}`],
    ['Pension (annual)', `Â£${pension.toLocaleString()}`],
    ['UK property value', `Â£${prop.toLocaleString()}`],
    ['Monthly budget surplus', `Â£${((Number(data.budgetIncome||0)-Number(data.budgetExpenses||0))).toLocaleString()}`],
    ['Readiness score', `${readiness}/100`]
  ];
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:8px">${r[0]}</td><td style="padding:8px">${r[1]}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('breakdown').style.display = 'block';

  // save final
  const final = { summary: parts.join('\n\n'), numeric: rows, collected: data, created: new Date().toISOString() };
  localStorage.setItem('ba_final_plan', JSON.stringify(final));
}

/* ------------- Collect data & Save draft ------------- */
function collectData(){
  const docsInput = document.getElementById('docs');
  const files = docsInput ? Array.from(docsInput.files || []).map(f => f.name) : [];
  return {
    country: countrySelect.value,
    cityPref: document.getElementById('cityPref').value,
    pension: document.getElementById('pension').value,
    propertyVal: document.getElementById('propertyValInput').value,
    incomeBracket: document.getElementById('q1').value,
    remoteWork: document.getElementById('q2').value,
    familyJoin: document.getElementById('q4').value,
    docs: files,
    budgetIncome: document.getElementById('budgetIncome').value,
    budgetExpenses: document.getElementById('budgetExpenses').value,
    pack1: document.getElementById('pack1').checked,
    pack2: document.getElementById('pack2').checked,
    pack3: document.getElementById('pack3').checked,
    propertyRent: document.getElementById('propertyRent').value,
    settleArea: document.getElementById('settleArea').value,
    conn1: document.getElementById('conn1').checked,
    conn2: document.getElementById('conn2').checked,
    conn3: document.getElementById('conn3').checked,
    taxStatus: document.getElementById('taxStatus').value,
    celebrationPlan: document.getElementById('celebrationPlan').value
  };
}
function saveDraft(){
  const draft = collectData();
  draft.completed = completed;
  localStorage.setItem('ba_draft', JSON.stringify(draft));
}

/* ------------- Restore draft ------------- */
function applyDraft(){
  try{
    const raw = localStorage.getItem('ba_draft');
    if(!raw) return;
    const d = JSON.parse(raw);
    if(d.country) countrySelect.value = d.country;
    if(d.cityPref) document.getElementById('cityPref').value = d.cityPref;
    if(d.pension) document.getElementById('pension').value = d.pension;
    if(d.propertyVal) document.getElementById('propertyValInput').value = d.propertyVal;
    if(d.incomeBracket) document.getElementById('q1').value = d.incomeBracket;
    if(d.remoteWork) document.getElementById('q2').value = d.remoteWork;
    if(d.familyJoin) document.getElementById('q4').value = d.familyJoin;
    if(d.docs && d.docs.length) document.getElementById('docsSummary').textContent = d.docs.join(' | ');
    if(d.budgetIncome) document.getElementById('budgetIncome').value = d.budgetIncome;
    if(d.budgetExpenses) document.getElementById('budgetExpenses').value = d.budgetExpenses;
    if(d.pack1) document.getElementById('pack1').checked = d.pack1;
    if(d.pack2) document.getElementById('pack2').checked = d.pack2;
    if(d.pack3) document.getElementById('pack3').checked = d.pack3;
    if(d.propertyRent) document.getElementById('propertyRent').value = d.propertyRent;
    if(d.settleArea) document.getElementById('settleArea').value = d.settleArea;
    if(d.conn1) document.getElementById('conn1').checked = d.conn1;
    if(d.conn2) document.getElementById('conn2').checked = d.conn2;
    if(d.conn3) document.getElementById('conn3').checked = d.conn3;
    if(d.taxStatus) document.getElementById('taxStatus').value = d.taxStatus;
    if(d.celebrationPlan) document.getElementById('celebrationPlan').value = d.celebrationPlan;
    if(d.completed) completed = d.completed;
  }catch(e){ console.warn('restore failed', e) }
}

/* ------------- Export / Copy / Reset ------------- */
function exportPlan(){
  const raw = localStorage.getItem('ba_final_plan') || JSON.stringify({collected: collectData(), created: new Date().toISOString()});
  const blob = new Blob([raw], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'BRITS-ABROAD-PLAN.json'; a.click();
  URL.revokeObjectURL(url);
}
function copySummary(){
  const raw = localStorage.getItem('ba_final_plan');
  if(!raw){ alert('Please generate the AI summary first.'); return; }
  const plan = JSON.parse(raw);
  navigator.clipboard?.writeText(plan.summary || JSON.stringify(plan, null, 2)).then(()=> alert('Copied to clipboard'), ()=> alert('Copy failed'));
}
function resetAll(){
  if(!confirm('Reset planner and clear saved data?')) return;
  localStorage.removeItem('ba_draft'); localStorage.removeItem('ba_final_plan'); localStorage.removeItem('ba_completed');
  location.reload();
}

/* ------------- Countdown ------------- */
function updateCountdown(){
  const deadline = new Date('2025-04-05T00:00:00Z');
  const now = new Date();
  const diff = deadline - now;
  const el = document.getElementById('countdown');
  if(diff <= 0){ el.textContent = 'NI Top-Up Window: CLOSED'; return; }
  const days = Math.floor(diff / (1000*60*60*24));
  const hours = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
  el.innerHTML = `NI Top-Up Window: <strong>${days} days ${hours} hours left</strong>`;
}

/* ------------- Init ------------- */
function init(){
  populateCountries();
  buildPhaseStrip();
  applyDraft();
  // attach immediate update calls
  calcFinance(); updateVisa(); updateBudget(); updateMove(); updateSettlement(); updateConnections(); updateTax(); updateCelebration();
  showPhase(1);
  setInterval(saveDraft, 2500);
  updateCountdown(); setInterval(updateCountdown, 60*60*1000);
}
init();
</script>
</body>
</html>
